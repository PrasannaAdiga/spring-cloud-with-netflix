package com.learning.cloud.controller;import com.fasterxml.jackson.core.JsonProcessingException;import com.fasterxml.jackson.databind.ObjectMapper;import com.learning.cloud.entity.Account;import com.learning.cloud.exception.ResourceNotFoundException;import com.learning.cloud.repository.AccountRepository;import lombok.RequiredArgsConstructor;import lombok.extern.slf4j.Slf4j;import org.springframework.http.HttpStatus;import org.springframework.http.ResponseEntity;import org.springframework.validation.annotation.Validated;import org.springframework.web.bind.annotation.*;import org.springframework.web.servlet.support.ServletUriComponentsBuilder;import javax.validation.Valid;import javax.validation.constraints.*;import java.math.BigDecimal;import java.net.URI;import java.util.Collections;import java.util.List;@RestController@RequestMapping("/v1/accounts")@Slf4j@Validated@RequiredArgsConstructorpublic class AccountController {    private final AccountRepository accountRepository;    private ObjectMapper objectMapper = new ObjectMapper();    //Returns http status OK - 200 with all requested Account details    //TODO: The result should send in the Pagination format    @GetMapping(params = "id")    public ResponseEntity<List<Account>> findByIds(@RequestParam                                                   @NotEmpty(message = "Should contain at-least single Id")                                                           List<String> id) {        return ResponseEntity.ok().body(accountRepository.findByIds(id));    }    //Returns http status OK - 200 with Account detail    @GetMapping("/{accountNumber}")    public ResponseEntity<Account> findByAccountNumber(@PathVariable("accountNumber")                                                       @Size(min = 1, max = 10, message = "Account number must be 1 to 10 digits only")                                                       @Positive(message = "Account number should be positive value")                                                               String accountNumber) {        Account account = accountRepository.findByAccountNumber(accountNumber).orElseThrow(                () -> new ResourceNotFoundException("Account with id " + accountNumber + " Not Found!"));        return ResponseEntity.ok().body(account);    }    //Returns nothing with Http Status as OK - 200. Also update the location tag with new created ID    @PostMapping    public ResponseEntity<Object> create(@Valid @RequestBody Account account) {        Account newAccount = accountRepository.add(account);        URI location = ServletUriComponentsBuilder.fromCurrentRequest().path("/{id}").buildAndExpand(newAccount.getId()).toUri();        return ResponseEntity.created(location).build();    }    //Returns updated Account with HttpStatus as OK - 200    @PutMapping    public ResponseEntity<Account> update(@Valid @RequestBody Account account) {        accountRepository.findByAccountNumber(account.getNumber()).orElseThrow(                () -> new ResourceNotFoundException("Account with id " + account.getId() + " Not Found!"));        return ResponseEntity.ok(accountRepository.update(account));    }    //Returns updated Account details with Http Status OK - 200    @PutMapping("/{id}/withdraw/{amount}")    public ResponseEntity<Account> withdraw(@PathVariable("id")                                            @Size(min = 1, max = 10, message = "Account number must be 1 to 10 digits only")                                            @Positive(message = "Account number should be positive value")                                                    String accountNumber,                                            @PathVariable("amount")                                            @NotNull(message = "Amount must not be null")                                            @Positive(message = "Withdraw amount must be greater than zero")                                                    int amount) throws JsonProcessingException {        Account account = accountRepository.findByAccountNumber(accountNumber).orElseThrow(                () -> new ResourceNotFoundException("Account with id " + accountNumber + " Not Found!"));        log.info("Account found: {}", objectMapper.writeValueAsString(account));        account.setBalance(account.getBalance().subtract(new BigDecimal(amount)));        log.info("Account balance: {}", objectMapper.writeValueAsString(Collections.singletonMap("balance", account.getBalance())));        return ResponseEntity.ok().body(accountRepository.update(account));    }    //Returns nothing with HttpStatus as NO CONTENT - 204    @DeleteMapping("/{accountNumber}")    public ResponseEntity<Void> delete(@PathVariable("accountNumber")                                         @Size(min = 1, max = 10, message = "Account number must be 1 to 10 digits only")                                         @Positive(message = "Account number should be positive value")                                                 String accountNumber) {        Account account = accountRepository.findByAccountNumber(accountNumber).orElseThrow(                () -> new ResourceNotFoundException("Account with id " + accountNumber + " Not Found!"));        accountRepository.deleteByAccountId(account.getId());        return new ResponseEntity<>(HttpStatus.NO_CONTENT);    }}